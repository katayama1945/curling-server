<html>
<head>
  <meta charset="utf-8">
  <title>カーリング対戦</title>
</head>
<body>
  <h1>オンラインカーリング</h1>
  <div id="statusDiv">状態を取得中...</div>
  <input id="nameInput" placeholder="名前を入力">
  <button id="joinBtn" style="display:inline;">🎮 参加する</button>

  <script>
let ws;

const statusDiv = document.getElementById("statusDiv");
const nameInput = document.getElementById("nameInput");
const joinBtn = document.getElementById("joinBtn");

// WebSocket接続
function setupWebSocket() {
  ws = new WebSocket("wss://curling-server.onrender.com");

  ws.onopen = () => {
    console.log("🔌 WebSocket接続完了");
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log("受信:", data);

    if (data.type === "status") {
      const msg = {
        "idle": "🟢 参加者受付中",
        "waiting": `🟡 ${data.player1 ?? "誰か"} が対戦者受付中...`,
        "playing": `🔴 対戦中：${data.player1 ?? "A"} vs ${data.player2 ?? "B"}`
      };
      statusDiv.textContent = msg[data.status];

      if (data.status === "idle" || data.status === "waiting") {
        joinBtn.style.display = "inline";
      } else {
        joinBtn.style.display = "none";
      }
    }
  };

  ws.onerror = (e) => {
    console.error("WebSocket エラー:", e);
  };
}

// 初期化処理
window.onload = () => {
  setupWebSocket();

  joinBtn.addEventListener("click", () => {
    const name = nameInput.value.trim();
    if (!name) {
      alert("名前を入力してください");
      return;
    }

    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "join", name }));
      joinBtn.style.display = "none";
    } else {
      alert("WebSocketが接続されていません。ページを再読み込みしてください。");
    }
  });
};
</script>
</body>
</html>
